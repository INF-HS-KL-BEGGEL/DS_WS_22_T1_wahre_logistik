---
title: "Lieferschein_Fragen"
author: "Alexander Opris, Felix Mayer, Lukas Felzmann"
output:
  html_notebook:
    toc: true
    toc_float: true
    code_folding: none
    number_sections: true
---

# Datenbankverbindung aufbauen

```{r message=FALSE, warning=FALSE}
library(DBI)
library(odbc)
library(dplyr)
library(lubridate)
library(tidyverse)
library(leaflet)
library(plotly)
readRenviron("../env_files/.Renviron.postgres")
ger_num <- scales::label_comma(accuracy = .01, big.mark = ".", decimal.mark = ",")
```

```{r}
con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "PostgreSQL Unicode",
                      Server   = Sys.getenv("host"),
                      Database = Sys.getenv("dbname"),
                      UID      = Sys.getenv("user"),
                      PWD      = Sys.getenv("password"),
                      Port     = Sys.getenv("port"))
```

# Lade Verkäufe
```{r}
vk <- dbGetQuery(conn=con, statement = "select * from verkaeufe")
```

# Lieferschein Präsentationsfragen
## Wenn uns die Menge der Artikel interessiert
Interessant: Es gibt 6 Verkäufe mit Abgang zwischen 0 und 1

```{r}
sum_abg <- sum(vk$abgang)
sum_abg
ger_num(sum_abg)
```

### Welche Gesamtmenge an Artikeln verlässt das Lager pro Tag?

```{r}
abg_per_day <- vk %>% group_by(datum) %>% summarize(sum_abg=sum(abgang))
#abg_per_day <- abg_per_day %>% complete(datum = seq.Date(min(datum), max(datum), by="day")) %>% mutate(sum_abg = ifelse(is.na(sum_abg), 0, sum_abg)) 
abg_per_day

ggplot(abg_per_day, aes(x=datum, y=sum_abg)) + geom_line()
```

### Wie viele unterschiedliche Artikel verlassen das Lager pro Tag?

```{r}
vk_per_day_per_type <- vk %>% group_by(datum) %>% summarise(different_materials=n_distinct(materialnummer))
vk_per_day_per_type
ggplot(vk_per_day_per_type, aes(x=datum, y=different_materials)) + geom_line()
```

### Welche Anzahl eines Artikels verlassen das Lager pro Tag?
TODO: Was/wie visualisieren?
```{r}
abg_per_day_single_material <- vk %>% group_by(datum,materialnummer) %>% summarize(sum_abg=sum(abgang))
abg_per_day_single_material
ggplot(abg_per_day_single_material, aes(x=datum, y=sum_abg)) + geom_point()
#plot_ly(abg_per_day_single_material, x = ~datum, y = ~sum_abg, z = ~materialnummer) %>% add_markers()
```

## Wenn uns der Umsatz der Artikel interessiert
### Welcher Umsatz wird pro Tag generiert?

```{r}
vk_per_day <- vk %>% group_by(datum) %>% summarize(sum_vk_preis_num=sum(vk_preis_num))

# vk_per_day
# ggplot(vk_per_day, aes(x=datum, y=sum_vk_preis_num)) + geom_line()
# vk_per_day <- vk_per_day %>% complete(datum = seq.Date(min(datum), max(datum), by="day")) %>% mutate(sum_vk_preis_num = ifelse(is.na(sum_vk_preis_num), 0, sum_vk_preis_num))

vk_per_day
ggplot(vk_per_day, aes(x=datum, y=sum_vk_preis_num)) + geom_line()
```

### Welcher Umsatz wird mit jedem einzelnen Artikel pro Tag generiert?
TODO: Was/wie visualisieren?
```{r}
vk_per_day_single_material <- vk %>% group_by(datum,materialnummer) %>% summarize(sum_vk=sum(vk_preis_num))
vk_per_day_single_material
#plot_ly(vk_per_day_single_material, x = ~datum, y = ~sum_vk, z = ~materialnummer) %>% add_markers()
```


## Wenn uns die Kunden interessieren
### Wie sind die Artikel auf die Kunden verteilt? 
TODO: Was/wie visualisieren? => auf ABC bezogen
```{r}
vk_per_kunde <- vk %>% group_by(kunde) %>% summarize(num_distinct_materials=n_distinct(materialnummer)) %>% arrange(desc(num_distinct_materials)) %>% mutate(rang=row_number())
vk_per_kunde

mean_distinct_mat <- vk_per_kunde %>% summarise(mean_distinct_mat=mean(num_distinct_materials))
ceiling(mean_distinct_mat)
```
### Wie ist der Umsatz auf die Kunden verteilt?
TODO: Was/wie visualisieren? => auf ABC mappen
```{r}
vk_per_kunde <- vk %>% group_by(kunde) %>% summarize(umsatz=sum(vk_preis_num)) %>% arrange(desc(umsatz)) %>% mutate(rang=row_number())
vk_per_kunde
```

## Wenn und die Kommissionierung interessiert
### Wieviele Lieferscheine werden am Tag bearbeitet?
```{r}
ls_per_day <- vk %>% group_by(datum) %>% summarize(num_ls=n_distinct(lieferschein))
ls_per_day
ggplot(ls_per_day, aes(x=datum, y=num_ls)) + geom_line()
```
### Wieviele Positionen sind damit verbunden?
```{r}
pos_per_day <- vk %>% group_by(datum) %>% summarize(num_pos=n())
pos_per_day
ggplot(pos_per_day, aes(x=datum, y=num_pos)) + geom_line()
```

### Wie ist das tägliche Sortiment strukturiert?

## Wenn uns die Klassifizierung der Artikel interessiert:
### Handelt es sich bei den Artikeln um A, B oder C-Artikel?
### In welcher Kombination verlassen die Artikel das Lager? (AA, AB, …)
### Welcher Umsatz wird pro Tag mit A, B oder C-Artikeln jeweils generiert?

# Lieferschein Zusatzfragen
## Lieferscheine mit nur einer Position
```{r}
unique_lieferscheine <- vk %>% group_by(lieferschein) %>% summarise(anzahl=n(), lf_sum_umsatz=sum(vk_preis_num), lf_sum_abgang=sum(abgang)) %>% filter(anzahl == 1)
```

```{r}
num_unique_lieferscheine <- unique_lieferscheine %>% summarise(rows=n(), gesamtumsatz=sum(lf_sum_umsatz), gesamtabgang=sum(lf_sum_abgang))

cat('Anzahl:' , num_unique_lieferscheine$rows)
cat('\nGesamtumsatz:' , ger_num(num_unique_lieferscheine$gesamtumsatz), '€')
cat('\nGesamtabgänge:' , ger_num(num_unique_lieferscheine$gesamtabgang))
```


```{sql connection=con}
SELECT COUNT(*) AS Anzahl FROM verkaeufe WHERE lieferschein IN (SELECT lieferschein FROM verkaeufe GROUP BY lieferschein HAVING COUNT(*) = 1);
SELECT SUM(vk_preis_num) AS Gesamtumsatz FROM verkaeufe WHERE lieferschein IN (SELECT lieferschein FROM verkaeufe GROUP BY lieferschein HAVING COUNT(*) = 1);
SELECT SUM(abgang) AS Gesamtabgaenge FROM verkaeufe WHERE lieferschein IN (SELECT lieferschein FROM verkaeufe GROUP BY lieferschein HAVING COUNT(*) = 1);
```

## Teillieferungen (Gleiche Lieferscheinnr. aber unterschiedliches Datum)
 
```{r}
teillieferungen <- vk %>% group_by(lieferschein) %>% filter(datum > min(datum)) %>% summarise(anzahl=n(), lf_sum_umsatz=sum(vk_preis_num), lf_sum_abgang=sum(abgang))

sum_teillieferungen <- teillieferungen %>% summarise(rows=n(), gesamtumsatz=sum(lf_sum_umsatz), gesamtabgang=sum(lf_sum_abgang))

cat('Anzahl:' , sum_teillieferungen$rows)
cat('\nGesamtumsatz:' , sum_teillieferungen$gesamtumsatz, '€')
cat('\nGesamtabgänge:' , sum_teillieferungen$gesamtabgang)
```

# Datenbankverbindung beenden
```{r}
dbDisconnect(con)
```