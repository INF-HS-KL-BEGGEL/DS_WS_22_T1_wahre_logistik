---
title: "Routing Performance"
author: "Alexander Opris, Felix Mayer, Lukas Felzmann"
output:
  html_notebook:
    toc: true
    toc_float: true
    code_folding: none
    number_sections: true
---



```{r include=FALSE}
library(DBI)
library(odbc)
library(readr)
library(leaflet)
library(dplyr)
library(stringr)
library(glue)
library(tictoc)
readRenviron("../env_files/.Renviron.postgres")
```

```{r include=FALSE}
con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = Sys.getenv("driver"),
                      Server   = Sys.getenv("host"),
                      Database = Sys.getenv("dbname_routing"),
                      UID      = Sys.getenv("user"),
                      PWD      = Sys.getenv("password"),
                      Port     = Sys.getenv("port"))
```

# Disclaimer: Urheberrecht
Die in den Analysen verwendeten Daten wurden uns von Prof. Dr.-Ing. Martin Wölker ([Hochschul-Profilseite](https://www.hs-kl.de/hochschule/profil/personenverzeichnis/detailanzeige-personen/person/martin-woelker)) zur Verfügung gestellt. Die Daten sind auf Herrn Wölkers Blog ([Martins wahre Logistik](https://martins-wahre-logistik.blogspot.com/2022/10/logistics-case-studies-der-lieferschein.html)) auffindbar. Zum gegenwärtigen Zeitpunkt (Stand: 07.12.2022) sind die Daten wie folgt lizenziert: CC BY-NC-SA



```{r include=FALSE}
# Ein paar lon-/lat-Paare zum Testen/Ausprobieren
# München: 11.558003,48.138399
# Hamburg: 10.007252,53.551518

# Aachen: 6.083915,50.775408
# Cottbus: 14.333189,51.760217

# FFM_1: 8.584785,50.095807
# FFM_2: 8.710613,50.128612

# ZW_1 (Kreuzberg): 7.363136,49.264416
# ZW_2 (Bubenhausen): 7.351200,49.246048
# ZW_3 (Hilgard-Center): 7.365502,49.254249
```

# Achtung
Diese Dokument ist ein erster Wurf. Bitte alle Todos beachten (auch im Code)

# München nach Hamburg
```{r include=FALSE}
start_coord <- list(lon=11.558003, lat=48.138399)
destination_coord <- list(lon=10.007252, lat=53.551518)
```

## Dijkstra ("Normal")
```{r echo=FALSE}
# Dijkstra ("Normal")
tic()

query <-  glue("
          -- Find nearest node to start coordinate
          WITH start as (
        	  SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({start_coord$lon}, {start_coord$lat}), 4326)
          	limit 1
          ),
          
          -- Find nearest node to end coordinate
          destination as (
          	SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({destination_coord$lon}, {destination_coord$lat}), 4326)
          	limit 1
          )
          
          -- Calculate the route
          SELECT *
          FROM pgr_dijkstra('
          SELECT id,
                source,
                target,
                cost,
                reverse_cost
          FROM de_edges',
          array(SELECT id FROM start),
          array(SELECT id FROM destination),
          TRUE) as route
          ");
          
route <- dbGetQuery(conn=con, statement = query)

toc()
```


## Dijsktra mit limitierender Bounding Box
Die Bounding Box, in der nach Routen gesucht wird, ist bei diesem Ansatz beschränkt.

```{r echo=FALSE}
# Dijkstra mit limitierender Bounding Box (Todo: Sinnvollen Expand-Parameter festlegen (aktuell sind es 0.1 Grad))
tic()

query <-  glue("
          -- Find nearest node to start coordinate
          WITH start as (
        	  SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({start_coord$lon}, {start_coord$lat}), 4326)
          	limit 1
          ),
          
          -- Find nearest node to end coordinate
          destination as (
          	SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({destination_coord$lon}, {destination_coord$lat}), 4326)
          	limit 1
          )
          
          -- Calculate the route
          SELECT *
          FROM pgr_dijkstra('
            SELECT id, 
                   source,
                   target,
                   cost,
                   reverse_cost
            FROM de_edges as e,
          (SELECT ST_Expand(ST_Extent(the_geom), 0.1) as box FROM de_edges as b
          WHERE b.source = '|| (SELECT id FROM start) ||'
          OR b.source = ' || (SELECT id FROM destination) || ') as box WHERE e.the_geom && box.box',
          array(SELECT id FROM start),
          array(SELECT id FROM destination),
          TRUE) as route;");
          
route <- dbGetQuery(conn=con, statement = query)
toc()
```


## Bidirektionaler Dijkstra mit limitierender Bounding Box
```{r echo=FALSE}
# Bidirektionaler Dijkstra mit limitierender Bounding Box (Todo: Sinnvollen Expand-Parameter festlegen (aktuell sind es 0.1 Grad))
tic()

query <-  glue("
          -- Find nearest node to start coordinate
          WITH start as (
        	  SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({start_coord$lon}, {start_coord$lat}), 4326)
          	limit 1
          ),
          
          -- Find nearest node to end coordinate
          destination as (
          	SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({destination_coord$lon}, {destination_coord$lat}), 4326)
          	limit 1
          )
          
          -- Calculate the route
          SELECT *
          FROM pgr_bdDijkstra('
            SELECT id, 
                   source,
                   target,
                   cost,
                   reverse_cost
            FROM de_edges as e,
          (SELECT ST_Expand(ST_Extent(the_geom), 0.1) as box FROM de_edges as b
          WHERE b.source = '|| (SELECT id FROM start) ||'
          OR b.source = ' || (SELECT id FROM destination) || ') as box WHERE e.the_geom && box.box',
          array(SELECT id FROM start),
          array(SELECT id FROM destination),
          TRUE) as route;");
          
route <- dbGetQuery(conn=con, statement = query)
toc()
```


# A-Star
```{r echo=FALSE}
# A-Star ("Normal")
# Todo: Noch über die anderen Options Gedanken machen (z. B. Heuristik)
tic()

query <-  glue("
          -- Find nearest node to start coordinate
          WITH start as (
        	  SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({start_coord$lon}, {start_coord$lat}), 4326)
          	limit 1
          ),
          
          -- Find nearest node to end coordinate
          destination as (
          	SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({destination_coord$lon}, {destination_coord$lat}), 4326)
          	limit 1
          )
          
          -- Calculate the route
          SELECT *
          FROM pgr_aStar(
          'SELECT id,
                  source,
                  target,
                  cost,
                  reverse_cost,
                  x1,
                  y1,
                  x2,
                  y2
          FROM de_edges as e,
          array(SELECT id FROM start),
          array(SELECT id FROM destination),
          TRUE) as route
          ");
          
route <- dbGetQuery(conn=con, statement = query)

toc()
```


# A-Star mit limitierender Bounding Box
```{r echo=FALSE}
# A-Star mit limitierender Bounding Box
# Todo: Noch über die anderen Options Gedanken machen (z. B. Heuristik)
tic()

query <-  glue("
          -- Find nearest node to start coordinate
          WITH start as (
        	  SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({start_coord$lon}, {start_coord$lat}), 4326)
          	limit 1
          ),
          
          -- Find nearest node to end coordinate
          destination as (
          	SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({destination_coord$lon}, {destination_coord$lat}), 4326)
          	limit 1
          )
          
          -- Calculate the route
          SELECT *
          FROM pgr_aStar(
          'SELECT id,
                  source,
                  target,
                  cost,
                  reverse_cost,
                  x1,
                  y1,
                  x2,
                  y2
          FROM de_edges as e,
          (SELECT ST_Expand(ST_Extent(the_geom), 0.1) as box FROM de_edges as b
          WHERE b.source = '|| (SELECT id FROM start) ||'
          OR b.source = ' || (SELECT id FROM destination) || ') as box WHERE e.the_geom && box.box',
          array(SELECT id FROM start),
          array(SELECT id FROM destination),
          TRUE) as route
          ");
          
route <- dbGetQuery(conn=con, statement = query)

toc()
```


## Bidirektionaler A-Star mit limitierender Bounding Box
```{r echo=FALSE}
# A-Star mit limitierender Bounding Box
# Todo: Noch über die anderen Options Gedanken machen (z. B. Heuristik)
tic()

query <-  glue("
          -- Find nearest node to start coordinate
          WITH start as (
        	  SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({start_coord$lon}, {start_coord$lat}), 4326)
          	limit 1
          ),
          
          -- Find nearest node to end coordinate
          destination as (
          	SELECT id
          	from de_edges_vertices_pgr
          	order by the_geom <-> ST_SetSRID(ST_MakePoint({destination_coord$lon}, {destination_coord$lat}), 4326)
          	limit 1
          )
          
          -- Calculate the route
          SELECT *
          FROM pgr_bdAstar(
          'SELECT id,
                  source,
                  target,
                  cost,
                  reverse_cost,
                  x1,
                  y1,
                  x2,
                  y2
          FROM de_edges as e,
          (SELECT ST_Expand(ST_Extent(the_geom), 0.1) as box FROM de_edges as b
          WHERE b.source = '|| (SELECT id FROM start) ||'
          OR b.source = ' || (SELECT id FROM destination) || ') as box WHERE e.the_geom && box.box',
          array(SELECT id FROM start),
          array(SELECT id FROM destination),
          TRUE) as route
          ");
          
route <- dbGetQuery(conn=con, statement = query)

toc()
```





## Todo: vielleicht noch andere Algorithmen ausprobieren
Todo



# ZW-Kreuzberg nach ZW-Bubenhausen
```{r include=FALSE}
start_coord <- list(lon=7.363136, lat=49.264416)
destination_coord <- list(lon=7.351200, lat=49.246048)
```

Todo


# Todo: vielleicht noch irgendeine mittellange Strecke
Todo



# Weiteres Todos
```{r}
# Wegen Performance --> Todo: noch anschauen
# https://docs.pgrouting.org/latest/en/contraction-family.html#contraction
# sp_delta
# st_buffer
```