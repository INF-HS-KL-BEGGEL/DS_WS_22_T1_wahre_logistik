---
title: "Analysen"
output: html_notebook
---

# Datenbankverbindung aufbauen

```{r message=FALSE, warning=FALSE}
library(DBI)
library(odbc)
library(dplyr)
library(lubridate)
library(tidyverse)
library(leaflet)
readRenviron("../env_files/.Renviron.postgres")
```

```{r}
con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "PostgreSQL Unicode",
                      Server   = Sys.getenv("host"),
                      Database = Sys.getenv("dbname"),
                      UID      = Sys.getenv("user"),
                      PWD      = Sys.getenv("password"),
                      Port     = Sys.getenv("port"))
```

# Analysen

## Gesamtumsatz

```{r}

vk <- dbGetQuery(conn=con, statement = "select materialnummer, abgang, vk_preis_num from verkaeufe")
gvk <- vk %>% summarise(vk_preis_num_gesamt=sum(vk_preis_num))
gvk

```

```{sql connection=con}

SELECT SUM(vk_preis_num) AS Gesamtumsatz FROM verkaeufe;

```

## Artikel

### Wie viele Artikel

```{r}
ms <- dbGetQuery(conn=con, statement = "select * from materialstaemme")
sprintf("Anzahl Artikel: %d", nrow(ms))
```
```{sql connection=con}
SELECT COUNT(*) AS anzahl_artikel FROM public.materialstaemme;
```

### Wie oft Verkauft

```{r warning=FALSE}
vk <- dbGetQuery(conn=con, statement = "select materialnummer, abgang, vk_preis_num from verkaeufe")
gvk <- vk %>% group_by(materialnummer) %>% summarise(vk_preis_num_gesamt=sum(vk_preis_num), abgang_gesamt = sum(abgang), datensaetze= n()) %>% arrange(desc(vk_preis_num_gesamt), desc(abgang_gesamt), desc(datensaetze))
gvk
```


```{sql connection=con}
SELECT materialnummer, SUM(vk_preis_num) as vk_preis_num_gesamt, SUM(abgang) as abgang_gesamt, COUNT(materialnummer) as datensaetze FROM public.verkaeufe GROUP BY materialnummer ORDER BY vk_preis_num_gesamt desc, abgang_gesamt desc, datensaetze desc;
```

### 10 Top-Selling Artikel
```{r}
gvk %>% head(10)
```


```{sql connection=con}
SELECT materialnummer, SUM(vk_preis_num) as vk_preis_num_gesamt, SUM(abgang) as abgang_gesamt, COUNT(materialnummer) as datensaetze FROM public.verkaeufe GROUP BY materialnummer ORDER BY vk_preis_num_gesamt desc, abgang_gesamt desc, datensaetze desc LIMIT(10);
```

## Kunden

### Wie viele Kunden

```{r}
ks <- dbGetQuery(conn=con, statement = "select * from kundenstammdaten")
sprintf("Anzahl Kunden: %d", nrow(ks))
```

```{sql connection=con}
SELECT COUNT(*) AS anzahl_kunden FROM kundenstammdaten;
```

### Wie viel kaufen die Kunden

```{r}
kvk <- dbGetQuery(conn=con, statement = "select kunde, abgang, vk_preis_num from verkaeufe")

gkvk <- kvk %>% group_by(kunde) %>% summarise(vk_preis_num_gesamt=sum(vk_preis_num), abgang_gesamt = sum(abgang), datensaetze= n()) %>% arrange(desc(vk_preis_num_gesamt), desc(abgang_gesamt), desc(datensaetze))


gkvk
```

```{sql connection=con}
SELECT kunde, SUM(vk_preis_num) as vk_preis_num_gesamt, SUM(abgang) as abgang_gesamt, COUNT(materialnummer) as datensaetze FROM public.verkaeufe GROUP BY kunde ORDER BY vk_preis_num_gesamt desc, abgang_gesamt desc, datensaetze desc;
```

### Geo-Vis von Kunden

```{r}
ks <- dbGetQuery(conn=con, statement = "select * from kundenstammdaten")

map <- leaflet(data = ks) %>% addTiles() %>%  addCircles(~laengengrad, ~breitengrad,  radius = .5, opacity = .2, col = "blue")

map
```


# Lieferschein

## Wie gro√ü sind die Lieferscheine

```{r}
ls <- dbGetQuery(conn=con, statement = "select lieferschein, abgang, vk_preis_num from verkaeufe")

gls <- ls %>% group_by(lieferschein) %>% summarise(vk_preis_num_gesamt=sum(vk_preis_num), abgang_gesamt = sum(abgang), datensaetze= n()) %>% arrange(desc(vk_preis_num_gesamt), desc(abgang_gesamt), desc(datensaetze))

gls
```

## Preise, Volumen und Gewicht

```{r}
vkjms <- dbGetQuery(conn=con, statement = "SELECT * FROM verkaeufe JOIN materialstaemme ON artikel = materialnummer")

gvkjms <- vkjms %>% group_by(lieferschein) %>% summarise(vk_preis_num_gesamt=sum(vk_preis_num), volumen_gesamt = sum(abgang*ve_pro_dm3), gewicht_gesamt=sum(abgang*ve_pro_kg), einzelteile_gesamt=sum(abgang*ve)) %>% arrange(desc(vk_preis_num_gesamt), desc(volumen_gesamt), desc(gewicht_gesamt), desc(einzelteile_gesamt))

gvkjms
```

# Zeit

## Lieferungen nach KW

```{r}

vk <- dbGetQuery(conn=con, statement = "select datum, vk_preis_num from verkaeufe")

gvk <- vk %>% mutate(kw = cut.Date(datum, breaks = "1 week", labels = FALSE)) %>% group_by(kw) %>% summarize(vk_preis_gesamt = sum(vk_preis_num))

gvk

ggplot(gvk, aes(x=kw, y=vk_preis_gesamt/1000)) + geom_col() + geom_text(aes(label = kw), vjust = -0.5, size=2)
```

## Lieferungen nach Monaten & Trends/Saisonale Effekte

```{r}
vk <- dbGetQuery(conn=con, statement = "select datum, vk_preis_num from verkaeufe")

gvk <- vk %>% group_by(month = lubridate::floor_date(datum, "month")) %>% summarize(vk_preis_num_gesamt=sum(vk_preis_num))

gvk

ggplot(gvk, aes(x=month, y=vk_preis_num_gesamt/1000)) + geom_col() + geom_text(aes(label = month), vjust = -0.5, size=2)
```

# Datenbankverbindung beenden
```{r}
dbDisconnect(con)
```